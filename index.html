<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PocketBase ‚Üí AI to Production Pipeline</title>
    <link rel="icon" href="favicon.png" type="image/png" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2563eb" />

    <!-- Local CodeMirror CSS -->
    <link rel="stylesheet" href="codemirror.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="dark">
    <button id="toggleTheme">üåì Toggle Theme</button>

    <div class="container">
      <h1>üõ†Ô∏è PocketBase ‚Üí AI to Production Pipeline</h1>

      <!-- Unified Workflow -->
      <div class="workflow">
        <div class="workflow-step active" data-step="p0">0. Prompt</div>
        <div class="workflow-step" data-step="p1">1. Merge</div>
        <div class="workflow-step" data-step="p2">2. Discover</div>
        <div class="workflow-step" data-step="p3">3. Cron Jobs</div>
        <div class="workflow-step" data-step="p4">4. Migrate</div>
        <div class="workflow-step" data-step="p5">5. Harden</div>
      </div>

      <!-- ========== STAGE 0: Prompt Generator ========== -->
      <div id="p0" class="tab-content active">
        <form class="form-grid">
          <h2>üìù Screen & Feature Info</h2>
          <label>Screen Name:</label>
          <input
            type="text"
            id="screenName"
            placeholder="e.g., CustomerManagement"
          />

          <label>Short Feature Description:</label>
          <input
            type="text"
            id="featureDesc"
            placeholder="e.g., Manage customer/vendor accounts"
          />

          <label>Required Components (comma-separated):</label>
          <input
            type="text"
            id="components"
            placeholder="e.g., Table, Filter bar, Modals, Toasts"
          />

          <label>PocketBase Collections (comma-separated):</label>
          <input
            type="text"
            id="collections"
            placeholder="e.g., users, tickets, orders"
          />

          <h2>üß© Reusables & UI Guidelines</h2>
          <label
            >Reusable Components/Services/Hooks to Avoid
            (comma-separated):</label
          >
          <input
            type="text"
            id="reusable"
            placeholder="e.g., OrderCard, useCurrentUser, orderService.js"
          />

          <label>Custom Design Guidelines:</label>
          <textarea
            id="designGuide"
            placeholder="Enter your custom Tailwind and UI rules here..."
          ></textarea>

          <label>Role:</label>
          <select id="role">
            <option value="admin">Admin</option>
            <option value="vendor">Vendor</option>
            <option value="agent">Agent</option>
            <option value="csr">CSR</option>
            <option value="customer">Customer</option>
          </select>

          <div class="button-group">
            <button type="button" id="gen0">‚öôÔ∏è Generate Prompt</button>
            <button type="button" id="copy0">üìã Copy</button>
            <button type="button" id="save0">üíæ Save</button>
            <button type="button" id="load0">üìÇ Load</button>
            <button type="button" id="export0">‚¨áÔ∏è Export as .md</button>
          </div>
          <textarea
            id="output0"
            placeholder="Generated prompt will appear here..."
          ></textarea>
        </form>
      </div>

      <!-- ========== STAGE 1: Universal AI Merge Builder ========== -->
      <div id="p1" class="tab-content">
        <header class="header">
          <div class="title">
            <h2>Enterprise AI Merge Builder ‚Äî Offline First</h2>
            <p class="lead">
              Merge <strong>any AI-generated code</strong>: services, UI
              components, hooks, scripts, configs, and more. 100% offline.
            </p>
          </div>
          <div class="toolbar">
            <div class="offline-indicator" id="network-status">
              <span class="dot" id="dot"></span>
              <span id="net-text" class="muted">checking‚Ä¶</span>
            </div>
            <button id="generate" class="btn">Generate Merge Prompt</button>
          </div>
        </header>

        <main class="layout">
          <section class="left-col">
            <div class="card">
              <label for="project-name"
                >Project / Feature name (optional)</label
              >
              <input
                id="project-name"
                placeholder="e.g., user-onboarding, dashboard-ui, auth-service"
              />

              <div class="input-group">
                <label>Drag & drop files here or click to upload</label>
                <div id="file-drop" class="file-drop">
                  Drop any code files (.js, .py, .go, .ts, .jsx, .vue, .sh,
                  .json, etc.)
                </div>
                <input id="file-input" type="file" multiple hidden />
              </div>

              <div class="row">
                <label>Merge goal / context</label>
                <select id="preset">
                  <option value="mild">
                    Preserve all logic ‚Äî minimal changes
                  </option>
                  <option value="moderate">
                    Reorganize for clarity and reuse
                  </option>
                  <option value="refactor">
                    Full refactor ‚Äî optimize structure & performance
                  </option>
                  <option value="ui-component">
                    Merge UI components (React, Vue, etc.)
                  </option>
                  <option value="client-hook">
                    Merge client-side hooks or composables
                  </option>
                  <option value="script">
                    Merge scripts (bash, Python, Node)
                  </option>
                  <option value="config">Merge config or rule files</option>
                </select>
              </div>

              <div class="stats">
                <div class="stat">
                  <span class="muted">Files:</span>
                  <span id="file-count" class="badge">0</span>
                </div>
                <div class="stat">
                  <span class="muted">Total chars:</span>
                  <span id="char-count" class="badge">0</span>
                </div>
                <div class="stat">
                  <span class="muted">Est. tokens:</span>
                  <span id="token-estimate" class="badge ok">0</span>
                </div>
              </div>

              <div id="advanced-section">
                <div class="card-section">
                  <label>Conflict resolution policy</label>
                  <div class="radio-row">
                    <label
                      ><input
                        type="radio"
                        name="conflict"
                        value="most_secure"
                        checked
                      />
                      Prefer Most Secure</label
                    >
                    <label
                      ><input type="radio" name="conflict" value="newest" />
                      Prefer Newest</label
                    >
                    <label
                      ><input type="radio" name="conflict" value="oldest" />
                      Prefer Oldest</label
                    >
                  </div>
                  <div class="muted small">
                    How to resolve conflicting implementations.
                  </div>
                </div>

                <div class="card-section">
                  <label>Options</label>
                  <div class="col">
                    <label
                      ><input type="checkbox" id="preserve-comments" checked />
                      Preserve original comments</label
                    >
                    <label
                      ><input type="checkbox" id="remove-duplicates" checked />
                      Eliminate duplicate logic</label
                    >
                    <label
                      ><input type="checkbox" id="keep-structure" /> Keep
                      existing file structure</label
                    >
                    <label
                      ><input type="checkbox" id="allow-ts" /> Allow
                      TypeScript</label
                    >
                  </div>
                </div>
              </div>

              <div class="card-section">
                <label for="extra-instructions"
                  >Extra instructions (optional)</label
                >
                <textarea
                  id="extra-instructions"
                  placeholder="e.g., target runtime Node 18, use ESM, avoid mutations..."
                ></textarea>
              </div>

              <div class="button-group">
                <button id="save-session" class="btn ghost small">
                  Save session
                </button>
                <button id="load-session" class="btn ghost small">
                  Load session
                </button>
                <button id="export-session" class="btn small">
                  Export .json
                </button>
                <label for="import-session" class="btn ghost small file-label"
                  >Import</label
                >
                <input
                  id="import-session"
                  type="file"
                  accept="application/json"
                  hidden
                />
              </div>
            </div>

            <div class="card" style="margin-top: 12px">
              <label>Duplicate Detection Preview</label>
              <div class="muted">
                Scans for exact or near-exact duplicate function
                implementations.
              </div>
              <div id="dup-list" class="dup-list"></div>
              <div class="button-group" style="margin-top: 8px">
                <button id="re-scan" class="btn ghost small">Re-scan</button>
                <button id="apply-duplicates" class="btn small">
                  Auto-consolidate
                </button>
              </div>
            </div>
          </section>

          <aside class="right-col">
            <div class="card">
              <label>Files (editable)</label>
              <div id="files" class="files"></div>
              <div class="button-group" style="margin-top: 8px">
                <button id="add-file" class="btn">+ Add empty file</button>
                <button id="clear-files" class="btn ghost">Clear all</button>
                <button id="download-session" class="btn ghost">
                  Save session as .json
                </button>
              </div>
            </div>

            <div class="card">
              <label>Generated Merge Prompt</label>
              <div id="preview" class="preview">
                Click "Generate Merge Prompt" to build an AI-ready instruction.
              </div>
              <div class="button-group" style="margin-top: 8px">
                <button id="copy" class="btn">Copy</button>
                <button id="download" class="btn ghost">Download .txt</button>
                <button id="copy-md" class="btn ghost">Copy as Markdown</button>
              </div>
              <div class="footer">
                Output will include directives about preserving logic, removing
                duplicates, and token estimates.
              </div>
            </div>
          </aside>
        </main>
      </div>

      <!-- ========== STAGE 2: Discover Logic ========== -->
      <div id="p2" class="tab-content">
        <div class="section" data-show="p2,p3,p4,p5">
          <div class="row">
            <div class="col">
              <label>Project name</label
              ><input id="project" type="text" placeholder="NaijaHoodWatch" />
            </div>
            <div class="col">
              <label>Project type</label>
              <select id="projectType">
                <option value="saas">SaaS</option>
                <option value="delivery" selected>Delivery</option>
                <option value="marketplace">Marketplace</option>
                <option value="admin">Admin</option>
                <option value="social">Social</option>
                <option value="custom">Custom‚Ä¶</option>
              </select>
              <input
                type="text"
                id="customProjectType"
                placeholder="e.g., Healthcare Portal"
                style="display: none"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Module / Domain</label
              ><input id="module" type="text" placeholder="agent" />
            </div>
            <div class="col">
              <label>File / Component name</label
              ><input
                id="serviceName"
                type="text"
                placeholder="agentService.js"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>What should this do?</label
              ><input
                id="useCase"
                type="text"
                placeholder="Handle agent onboarding"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>‚ö†Ô∏è Other components depend on this</label>
              <select id="dependencies">
                <option value="low">Low ‚Äî Standalone</option>
                <option value="medium">Medium ‚Äî 2‚Äì3 screens</option>
                <option value="high" selected>
                  High ‚Äî Critical, used across app
                </option>
              </select>
            </div>
          </div>
          <label>Additional constraints (optional)</label>
          <input
            id="constraints"
            type="text"
            placeholder="Use transactions, add audit logs"
          />
          <label>Paste merged service code</label>
          <textarea
            id="code"
            placeholder="Paste your merged service file..."
          ></textarea>
        </div>

        <div class="actions">
          <button class="btn primary" id="gen2">Generate</button>
          <button class="btn ghost" id="copy2">Copy</button>
          <button class="btn ghost" id="save2">Save</button>
          <button class="btn ok" id="next2">‚û°Ô∏è Cron Jobs</button>
          <button class="btn warn" id="clear2">Clear</button>
        </div>
        <div class="hr"></div>
        <div id="out2" class="mono" aria-live="polite"></div>
      </div>

      <!-- ========== STAGE 3: Extract Cron Jobs ========== -->
      <div id="p3" class="tab-content">
        <div class="section" data-show="p3">
          <div class="row">
            <div class="col">
              <label>Project name</label
              ><input id="project" type="text" placeholder="NaijaHoodWatch" />
            </div>
            <div class="col">
              <label>Project type</label>
              <select id="projectType">
                <option value="saas">SaaS</option>
                <option value="delivery" selected>Delivery</option>
                <option value="marketplace">Marketplace</option>
                <option value="admin">Admin</option>
                <option value="social">Social</option>
                <option value="custom">Custom‚Ä¶</option>
              </select>
              <input
                type="text"
                id="customProjectType"
                placeholder="e.g., Healthcare Portal"
                style="display: none"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Module / Domain</label
              ><input id="module" type="text" placeholder="agent" />
            </div>
            <div class="col">
              <label>File / Component name</label
              ><input
                id="serviceName"
                type="text"
                placeholder="agentService.js"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>What should this do?</label
              ><input
                id="useCase"
                type="text"
                placeholder="Handle agent onboarding"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>‚ö†Ô∏è Other components depend on this</label>
              <select id="dependencies">
                <option value="low">Low ‚Äî Standalone</option>
                <option value="medium">Medium ‚Äî 2‚Äì3 screens</option>
                <option value="high" selected>
                  High ‚Äî Critical, used across app
                </option>
              </select>
            </div>
          </div>
          <label>Additional constraints (optional)</label>
          <input
            id="constraints"
            type="text"
            placeholder="Use transactions, add audit logs"
          />
          <label>Paste merged service code</label>
          <textarea
            id="code"
            placeholder="Paste your merged service file..."
          ></textarea>
        </div>

        <div class="actions">
          <button class="btn primary" id="gen3">Generate</button>
          <button class="btn ghost" id="copy3">Copy</button>
          <button class="btn ghost" id="save3">Save</button>
          <button class="btn ok" id="next3">‚û°Ô∏è Migrate</button>
          <button class="btn warn" id="clear3">Clear</button>
        </div>
        <div class="hr"></div>
        <div id="out3" class="mono" aria-live="polite"></div>
      </div>

      <!-- ========== STAGE 4: Migrate to pb_hooks ========== -->
      <div id="p4" class="tab-content">
        <div class="section" data-show="p4">
          <div class="row">
            <div class="col">
              <label>Project name</label
              ><input id="project" type="text" placeholder="NaijaHoodWatch" />
            </div>
            <div class="col">
              <label>Project type</label>
              <select id="projectType">
                <option value="saas">SaaS</option>
                <option value="delivery" selected>Delivery</option>
                <option value="marketplace">Marketplace</option>
                <option value="admin">Admin</option>
                <option value="social">Social</option>
                <option value="custom">Custom‚Ä¶</option>
              </select>
              <input
                type="text"
                id="customProjectType"
                placeholder="e.g., Healthcare Portal"
                style="display: none"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Module / Domain</label
              ><input id="module" type="text" placeholder="agent" />
            </div>
            <div class="col">
              <label>File / Component name</label
              ><input
                id="serviceName"
                type="text"
                placeholder="agentService.js"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>What should this do?</label
              ><input
                id="useCase"
                type="text"
                placeholder="Handle agent onboarding"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>‚ö†Ô∏è Other components depend on this</label>
              <select id="dependencies">
                <option value="low">Low ‚Äî Standalone</option>
                <option value="medium">Medium ‚Äî 2‚Äì3 screens</option>
                <option value="high" selected>
                  High ‚Äî Critical, used across app
                </option>
              </select>
            </div>
          </div>
          <label>Additional constraints (optional)</label>
          <input
            id="constraints"
            type="text"
            placeholder="Use transactions, add audit logs"
          />
          <label>Paste merged service code</label>
          <textarea
            id="code"
            placeholder="Paste your merged service file..."
          ></textarea>

          <div class="row">
            <div class="col">
              <label>Target language</label>
              <select id="language">
                <option value="go" selected>Go (recommended)</option>
                <option value="lua">Lua</option>
              </select>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="gen4">Generate</button>
          <button class="btn ghost" id="copy4">Copy</button>
          <button class="btn ghost" id="save4">Save</button>
          <button class="btn ok" id="next4">‚û°Ô∏è Harden</button>
          <button class="btn warn" id="clear4">Clear</button>
        </div>
        <div class="hr"></div>
        <div id="out4" class="mono" aria-live="polite"></div>
      </div>

      <!-- ========== STAGE 5: Harden Code ========== -->
      <div id="p5" class="tab-content">
        <div class="section" data-show="p5">
          <div class="row">
            <div class="col">
              <label>Project name</label
              ><input id="project" type="text" placeholder="NaijaHoodWatch" />
            </div>
            <div class="col">
              <label>Project type</label>
              <select id="projectType">
                <option value="saas">SaaS</option>
                <option value="delivery" selected>Delivery</option>
                <option value="marketplace">Marketplace</option>
                <option value="admin">Admin</option>
                <option value="social">Social</option>
                <option value="custom">Custom‚Ä¶</option>
              </select>
              <input
                type="text"
                id="customProjectType"
                placeholder="e.g., Healthcare Portal"
                style="display: none"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Module / Domain</label
              ><input id="module" type="text" placeholder="agent" />
            </div>
            <div class="col">
              <label>File / Component name</label
              ><input
                id="serviceName"
                type="text"
                placeholder="agentService.js"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>What should this do?</label
              ><input
                id="useCase"
                type="text"
                placeholder="Handle agent onboarding"
              />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>‚ö†Ô∏è Other components depend on this</label>
              <select id="dependencies">
                <option value="low">Low ‚Äî Standalone</option>
                <option value="medium">Medium ‚Äî 2‚Äì3 screens</option>
                <option value="high" selected>
                  High ‚Äî Critical, used across app
                </option>
              </select>
            </div>
          </div>
          <label>Additional constraints (optional)</label>
          <input
            id="constraints"
            type="text"
            placeholder="Use transactions, add audit logs"
          />
          <label>Paste merged service code</label>
          <textarea
            id="code"
            placeholder="Paste your merged service file..."
          ></textarea>

          <div class="row">
            <div class="col">
              <label>Security emphasis</label>
              <select id="security">
                <option value="standard" selected>Standard</option>
                <option value="strict">Strict (enterprise)</option>
              </select>
            </div>
            <div class="col">
              <label>Output style</label>
              <select id="style">
                <option value="js" selected>JavaScript only</option>
                <option value="ts_ok">TypeScript allowed</option>
              </select>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="gen5">Generate</button>
          <button class="btn ghost" id="copy5">Copy</button>
          <button class="btn ghost" id="save5">Save</button>
          <button class="btn warn" id="clear5">Clear</button>
        </div>
        <div class="hr"></div>
        <div id="out5" class="mono" aria-live="polite"></div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" role="alert"></div>

    <!-- Help Modal -->
    <div id="helpModal">
      <div class="modal-content">
        <h3>PocketBase AI Pipeline v3.8</h3>
        <p>
          From idea to production: Prompt ‚Üí Merge ‚Üí Discover ‚Üí Cron ‚Üí Migrate ‚Üí
          Harden
        </p>
        <p>All processing is 100% offline. No data leaves your device.</p>
        <button onclick="closeHelp()">Got it</button>
      </div>
    </div>

    <!-- Scripts -->
    <script src="codemirror.js" defer></script>
    <script src="javascript.js" defer></script>
    <script src="python.js" defer></script>
    <script src="script.js" defer></script>
    <script>
      // ---------- Service Worker Registration (Fixed) ----------
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((reg) => {
              console.log("Service Worker registered:", reg);
            })
            .catch((err) => {
              console.error("Service Worker registration failed:", err);
            });
        });
      }
    </script>
  </body>
</html>
